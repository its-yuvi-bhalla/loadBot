"use client";

import { useEffect, useState } from "react";
import { useParams } from "next/navigation";
import Link from "next/link";
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend,
  Cell,
} from "recharts";
import { Header } from "@/components/Header";

interface VerdictReason {
  threshold: string;
  message: string;
  actual?: number;
  limit?: number;
}

interface ResultsData {
  id: string;
  status: string;
  config: { targetUrl: string; method: string; durationSeconds: number };
  startedAt: number;
  completedAt?: number;
  metrics: {
    totalRequests: number;
    successfulRequests: number;
    failedRequests: number;
    errorRatePercentage: number;
    requestsPerSecond: number;
    avgResponseTime: number;
    minResponseTime: number;
    maxResponseTime: number;
    p95ResponseTime: number;
    p99ResponseTime: number;
  };
  verdict: string;
  thresholdVerdict?: string;
  verdictReasons?: VerdictReason[];
  firstViolationAt?: number;
  safetyScore?: { score: number; label: string; explanation: string };
  timeSeries: { time: number; responseTime: number; errorRate: number; successCount: number; failCount: number }[];
}

export default function ResultsPage() {
  const params = useParams();
  const testId = params.testId as string;
  const [data, setData] = useState<ResultsData | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!testId) return;
    fetch(`/api/load-test/${testId}/results`)
      .then((res) => {
        if (!res.ok) throw new Error("Test not found");
        return res.json();
      })
      .then(setData)
      .catch(() => setError("Test not found"));
  }, [testId]);

  if (error) {
    return (
      <div className="min-h-screen bg-[var(--background)]">
        <Header />
        <main className="mx-auto max-w-2xl px-4 py-10">
          <p className="text-[var(--danger)]">{error}</p>
          <Link href="/" className="mt-4 inline-block text-[var(--accent)] hover:underline">
            Back to home
          </Link>
        </main>
      </div>
    );
  }

  if (!data) {
    return (
      <div className="min-h-screen bg-[var(--background)]">
        <Header />
        <main className="mx-auto max-w-4xl px-4 py-10">
          <div className="flex flex-col items-center justify-center gap-4 py-16">
            <div className="h-8 w-8 animate-spin rounded-full border-2 border-[var(--accent)] border-t-transparent" />
            <p className="text-[var(--muted)]">Loading results…</p>
          </div>
        </main>
      </div>
    );
  }

  const { metrics, safetyScore, timeSeries, config } = data;
  const chartData = timeSeries.map((d) => ({
    ...d,
    timeLabel: new Date(d.time).toLocaleTimeString(),
  }));

  function exportCsv() {
    window.open(`/api/load-test/${testId}/export?format=csv`, "_blank");
  }
  function exportJson() {
    window.open(`/api/load-test/${testId}/export?format=json`, "_blank");
  }
  function exportPdf() {
    const w = window.open("", "_blank");
    if (!w) return;
    w.document.write(`
      <!DOCTYPE html><html><head><title>Load Test Report - ${data.id}</title></head><body style="font-family:sans-serif;padding:2rem;max-width:720px;margin:0 auto">
        <h1>Load Test Report</h1>
        <p><strong>Test ID:</strong> ${data.id}</p>
        <p><strong>Target:</strong> ${config.targetUrl} · ${config.method} · ${config.durationSeconds}s</p>
        <p><strong>Verdict:</strong> ${data.thresholdVerdict ?? data.verdict}</p>
        <p><strong>Safety score:</strong> ${safetyScore?.score ?? "—"} (${safetyScore?.label ?? "—"})</p>
        <p>${safetyScore?.explanation ?? ""}</p>
        <h2>Metrics</h2>
        <p>Total: ${metrics.totalRequests} · Success: ${metrics.successfulRequests} · Failed: ${metrics.failedRequests} · Error rate: ${metrics.errorRatePercentage.toFixed(1)}%</p>
        <p>RPS: ${metrics.requestsPerSecond.toFixed(2)} · Avg: ${metrics.avgResponseTime.toFixed(0)}ms · P95: ${metrics.p95ResponseTime.toFixed(0)}ms · P99: ${metrics.p99ResponseTime.toFixed(0)}ms</p>
        ${(data.verdictReasons?.length ?? 0) > 0 ? `<h2>Verdict reasons</h2><ul>${data.verdictReasons!.map((r) => `<li>${r.message}</li>`).join("")}</ul>` : ""}
        ${data.firstViolationAt ? `<p><strong>First violation:</strong> ${new Date(data.firstViolationAt).toISOString()}</p>` : ""}
        <p style="margin-top:2rem;color:#666">Generated by LoadBot. Use browser Print → Save as PDF.</p>
      </body></html>
    `);
    w.document.close();
    w.focus();
    setTimeout(() => w.print(), 300);
  }

  const barData = [
    { name: "Success", count: metrics.successfulRequests, fill: "var(--success)" },
    { name: "Failed", count: metrics.failedRequests, fill: "var(--danger)" },
  ];

  const safetyColor =
    safetyScore?.label === "SAFE"
      ? "var(--safe)"
      : safetyScore?.label === "WARNING"
        ? "var(--warning-label)"
        : "var(--danger-label)";

  return (
    <div className="min-h-screen bg-[var(--background)]">
      <Header />
      <main className="mx-auto max-w-6xl px-4 py-10">
        <div className="mb-8 flex flex-wrap items-center justify-between gap-4">
          <h1 className="text-2xl font-semibold text-[var(--foreground)]">
            Test results
          </h1>
          <div className="flex flex-wrap items-center gap-2">
            <button
              type="button"
              onClick={exportCsv}
              className="rounded-lg border border-[var(--card-border)] bg-[var(--card)] px-3 py-2 text-sm text-[var(--foreground)] hover:opacity-90"
            >
              Export CSV
            </button>
            <button
              type="button"
              onClick={exportJson}
              className="rounded-lg border border-[var(--card-border)] bg-[var(--card)] px-3 py-2 text-sm text-[var(--foreground)] hover:opacity-90"
            >
              Export JSON
            </button>
            <button
              type="button"
              onClick={exportPdf}
              className="rounded-lg border border-[var(--card-border)] bg-[var(--card)] px-3 py-2 text-sm text-[var(--foreground)] hover:opacity-90"
            >
              PDF report
            </button>
            <Link
              href="/"
              className="rounded-lg border border-[var(--card-border)] bg-[var(--card)] px-4 py-2 text-sm text-[var(--foreground)] hover:opacity-90"
            >
              New test
            </Link>
          </div>
        </div>

        {(data.verdictReasons?.length ?? 0) > 0 && (
          <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
            <h2 className="mb-2 text-lg font-medium text-[var(--foreground)]">
              Verdict: {data.thresholdVerdict ?? data.verdict}
            </h2>
            <ul className="list-disc pl-5 text-sm text-[var(--muted)]">
              {data.verdictReasons!.map((r, i) => (
                <li key={i}>{r.message}</li>
              ))}
            </ul>
            {data.firstViolationAt != null && (
              <p className="mt-3 text-xs text-[var(--muted)]">
                First violation at: {new Date(data.firstViolationAt).toLocaleString()}
              </p>
            )}
          </div>
        )}

        {/* Safety score card */}
        <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
          <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
            Safety score
          </h2>
          <div className="flex flex-wrap items-start gap-8">
            <div className="flex flex-col items-center">
              <div
                className="relative h-32 w-32 rounded-full p-1"
                style={{
                  background: `conic-gradient(${safetyColor} 0% ${safetyScore?.score ?? 0}%, var(--card-border) ${safetyScore?.score ?? 0}% 100%)`,
                }}
              >
                <div className="flex h-full w-full items-center justify-center rounded-full bg-[var(--card)]">
                  <span
                    className="text-2xl font-bold"
                    style={{ color: safetyColor }}
                  >
                    {safetyScore?.score ?? 0}
                  </span>
                </div>
              </div>
              <span
                className="mt-2 text-lg font-semibold"
                style={{ color: safetyColor }}
              >
                {safetyScore?.label ?? "—"}
              </span>
            </div>
            <div className="flex-1 min-w-0">
              <p className="text-sm text-[var(--muted)]">
                {safetyScore?.explanation}
              </p>
            </div>
          </div>
        </div>

        {/* Summary metrics */}
        <div className="mb-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div className="rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-4 shadow-sm">
            <p className="text-sm text-[var(--muted)]">Total requests</p>
            <p className="text-xl font-semibold text-[var(--foreground)]">
              {metrics.totalRequests}
            </p>
          </div>
          <div className="rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-4 shadow-sm">
            <p className="text-sm text-[var(--muted)]">Requests/sec</p>
            <p className="text-xl font-semibold text-[var(--foreground)]">
              {metrics.requestsPerSecond.toFixed(2)}
            </p>
          </div>
          <div className="rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-4 shadow-sm">
            <p className="text-sm text-[var(--muted)]">Error rate</p>
            <p
              className={`text-xl font-semibold ${
                metrics.errorRatePercentage > 60
                  ? "text-[var(--danger)]"
                  : metrics.errorRatePercentage > 30
                    ? "text-[var(--warning)]"
                    : "text-[var(--foreground)]"
              }`}
            >
              {metrics.errorRatePercentage.toFixed(1)}%
            </p>
          </div>
          <div className="rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-4 shadow-sm">
            <p className="text-sm text-[var(--muted)]">Verdict</p>
            <p
              className={`text-lg font-semibold ${
                (data.thresholdVerdict ?? data.verdict) === "FAIL" ||
                (data.thresholdVerdict ?? data.verdict) === "CRITICAL"
                  ? "text-[var(--danger)]"
                  : (data.thresholdVerdict ?? data.verdict) === "DEGRADED" ||
                      (data.thresholdVerdict ?? data.verdict) === "UNSTABLE"
                    ? "text-[var(--warning)]"
                    : "text-[var(--success)]"
              }`}
            >
              {data.thresholdVerdict ?? data.verdict}
            </p>
          </div>
        </div>

        {/* Timeline & observability */}
        {timeSeries.length > 0 && (
          <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
            <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
              Timeline & events
            </h2>
            <div className="flex flex-wrap gap-2">
              {data.firstViolationAt != null && (
                <span
                  className="inline-flex items-center rounded border border-[var(--danger)] bg-[var(--danger)]/10 px-2 py-1 text-xs text-[var(--danger)]"
                  title={new Date(data.firstViolationAt).toLocaleString()}
                >
                  Threshold violation @ {new Date(data.firstViolationAt).toLocaleTimeString()}
                </span>
              )}
              {chartData
                .filter((d) => d.errorRate >= 30)
                .slice(0, 5)
                .map((d, i) => (
                  <span
                    key={`err-${i}`}
                    className="inline-flex items-center rounded border border-[var(--warning)] bg-[var(--warning)]/10 px-2 py-1 text-xs text-[var(--warning)]"
                    title={`${d.errorRate.toFixed(1)}% error rate at ${new Date(d.time).toLocaleTimeString()}`}
                  >
                    Error burst @ {new Date(d.time).toLocaleTimeString()} ({d.errorRate.toFixed(0)}%)
                  </span>
                ))}
              {chartData
                .filter((d) => metrics.avgResponseTime > 0 && d.responseTime >= metrics.avgResponseTime * 2)
                .slice(0, 5)
                .map((d, i) => (
                  <span
                    key={`lat-${i}`}
                    className="inline-flex items-center rounded border border-[var(--accent)] bg-[var(--accent)]/10 px-2 py-1 text-xs text-[var(--accent)]"
                    title={`${d.responseTime.toFixed(0)}ms at ${new Date(d.time).toLocaleTimeString()}`}
                  >
                    Latency spike @ {new Date(d.time).toLocaleTimeString()} ({d.responseTime.toFixed(0)}ms)
                  </span>
                ))}
            </div>
            {data.firstViolationAt == null &&
              chartData.filter((d) => d.errorRate >= 30).length === 0 &&
              chartData.filter((d) => metrics.avgResponseTime > 0 && d.responseTime >= metrics.avgResponseTime * 2).length === 0 && (
                <p className="mt-2 text-sm text-[var(--muted)]">No threshold violations or notable spikes.</p>
              )}
          </div>
        )}

        {/* Response time over time */}
        <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
          <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
            Response time over time
          </h2>
          <div className="h-64">
            {chartData.length === 0 ? (
              <div className="flex h-full items-center justify-center text-sm text-[var(--muted)]">
                No time-series data
              </div>
            ) : (
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" stroke="var(--card-border)" />
                <XAxis dataKey="timeLabel" stroke="var(--muted)" fontSize={12} />
                <YAxis stroke="var(--muted)" fontSize={12} unit=" ms" />
                <Tooltip
                  contentStyle={{
                    background: "var(--card)",
                    border: "1px solid var(--card-border)",
                    borderRadius: "8px",
                  }}
                  labelStyle={{ color: "var(--foreground)" }}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="responseTime"
                  name="Response time (ms)"
                  stroke="var(--accent)"
                  strokeWidth={2}
                  dot={false}
                />
              </LineChart>
            </ResponsiveContainer>
            )}
          </div>
        </div>

        {/* Error rate over time */}
        <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
          <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
            Error rate over time
          </h2>
          <div className="h-64">
            {chartData.length === 0 ? (
              <div className="flex h-full items-center justify-center text-sm text-[var(--muted)]">
                No time-series data
              </div>
            ) : (
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" stroke="var(--card-border)" />
                <XAxis dataKey="timeLabel" stroke="var(--muted)" fontSize={12} />
                <YAxis stroke="var(--muted)" fontSize={12} unit=" %" />
                <Tooltip
                  contentStyle={{
                    background: "var(--card)",
                    border: "1px solid var(--card-border)",
                    borderRadius: "8px",
                  }}
                  labelStyle={{ color: "var(--foreground)" }}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="errorRate"
                  name="Error rate (%)"
                  stroke="var(--danger)"
                  strokeWidth={2}
                  dot={false}
                />
              </LineChart>
            </ResponsiveContainer>
            )}
          </div>
        </div>

        {/* Success vs Failed bar chart */}
        <div className="mb-8 rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
          <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
            Success vs failed requests
          </h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={barData} layout="vertical" margin={{ left: 60 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="var(--card-border)" />
                <XAxis type="number" stroke="var(--muted)" fontSize={12} />
                <YAxis type="category" dataKey="name" stroke="var(--muted)" fontSize={12} width={50} />
                <Tooltip
                  contentStyle={{
                    background: "var(--card)",
                    border: "1px solid var(--card-border)",
                    borderRadius: "8px",
                  }}
                />
                <Bar dataKey="count" name="Count" radius={[0, 4, 4, 0]}>
                  {barData.map((entry, index) => (
                    <Cell key={index} fill={entry.fill} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Latency summary */}
        <div className="rounded-xl border border-[var(--card-border)] bg-[var(--card)] p-6 shadow-sm">
          <h2 className="mb-4 text-lg font-medium text-[var(--foreground)]">
            Latency summary
          </h2>
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
            <div>
              <p className="text-sm text-[var(--muted)]">Avg</p>
              <p className="text-lg font-semibold text-[var(--foreground)]">
                {metrics.avgResponseTime.toFixed(0)} ms
              </p>
            </div>
            <div>
              <p className="text-sm text-[var(--muted)]">Min</p>
              <p className="text-lg font-semibold text-[var(--foreground)]">
                {metrics.minResponseTime.toFixed(0)} ms
              </p>
            </div>
            <div>
              <p className="text-sm text-[var(--muted)]">Max</p>
              <p className="text-lg font-semibold text-[var(--foreground)]">
                {metrics.maxResponseTime.toFixed(0)} ms
              </p>
            </div>
            <div>
              <p className="text-sm text-[var(--muted)]">P95</p>
              <p className="text-lg font-semibold text-[var(--foreground)]">
                {metrics.p95ResponseTime.toFixed(0)} ms
              </p>
            </div>
            <div>
              <p className="text-sm text-[var(--muted)]">P99</p>
              <p className="text-lg font-semibold text-[var(--foreground)]">
                {metrics.p99ResponseTime.toFixed(0)} ms
              </p>
            </div>
          </div>
          <p className="mt-4 text-sm text-[var(--muted)]">
            Target: {config.targetUrl} · {config.method} · {config.durationSeconds}s
          </p>
        </div>
      </main>
    </div>
  );
}
